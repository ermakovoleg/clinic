{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Запись к врачу</title>
    <link href="{% static "css/bootstrap.min.css" %}" rel="stylesheet">
  </head>
  <body>
        <div class="container col-md-offset-3 col-md-6">
            <div class="tab-content">
                <div class="tab active" id="home">
                    <div class="page-header">
                        <h1>Выберите врача</h1>
                    </div>
                    <form class="form-horizontal">
                        {% csrf_token %}
                        <div class="form-group">
                            <label class="control-label col-md-2" for="id_doctor">Доктор</label>
                            <div class="col-md-10">
                                <select class="form-control" id="id_doctor" name="doctor">
                                    {% for doctor in doctors %}
                                        <option value="{{ doctor.id }}">{{ doctor.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="tab hidden" id="date">
                    <div class="page-header">
                        <h1>Выберите дату</h1>
                    </div>
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="control-label col-md-2" for="datepicker">Дата</label>
                            <div class="col-md-10">
                                <input class="form-control" type="date" id="datepicker">
                            </div>
                        </div>
                    </form>
                </div>

                <div class="tab hidden" id="time">
                    <div class="page-header">
                        <h1>Выберите время</h1>
                    </div>
                    <div class="btn-group-vertical btn-group-lg" role="group" aria-label="Время" id="timeline"></div>
                </div>
                <div class="tab hidden" id="confirm">
                    <div class="page-header">
                        <h1>Введите Ваше ФИО</h1>
                    </div>
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="control-label col-md-2" for="fio">ФИО</label>
                            <div class="col-md-10">
                                <input class="form-control" type="text" id="fio">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div>
                <div class="col-md-1">
                    <button id="back" class="btn btn-default hidden">Назад</button>
                </div>
                <div class="col-md-offset-11">
                    <button id="next" class="btn btn-default">Далее</button>
                </div>
            </div>
        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="{% static "js/bootstrap.min.js" %}"></script>
        <script>
            function next_tab(tab){
                $(tab).addClass('hidden').removeClass('active');
                $(tab).next().removeClass('hidden').addClass('active');
            }
            function in_array(value, array) {
                for(var i = 0; i < array.length; i++) {
                    if(array[i] == value) return true;}
                return false;
            }

            function upd_button(busy_time){
                html = '';
                for (var i = 9; i <= 17; i++) {
                    if (in_array(i, busy_time)) {
                        html += '<button type="button" class="btn btn-default" disabled="disabled">'+ i +'</button>';
                    } else{
                        html += '<button type="button" class="btn btn-default">'+ i +'</button>';
                    }
                }
                $('#timeline').html(html);
                $('#timeline button').click(function(){
                    $(this).siblings().removeClass('btn-primary');
                    $(this).addClass('btn-primary')
                });
            }

            $("#back").click(function() {
                var tab = $('.active');
                $(tab).addClass('hidden').removeClass('active');
                $(tab).prev().removeClass('hidden').addClass('active');
                if ($(tab).prev().attr('id') == 'home'){
                    $(this).addClass('hidden')
                }
            });

            var doctor_id, date, time, fio;

            $("#next").click(function() {
                var tab = $('.active');
                switch ($(tab).attr('id')) {
                    case 'date':
                        doctor_id = $('#id_doctor').val();
                        date = $('#datepicker').val();
                        if (date==''){
                            alert('Укажите дату');
                            break;
                        }
                        $.ajax({
                            url: "/doctor/" + doctor_id + "/",
                            type: "GET",
                            data: {date: date},
                            success: function(data) {
                                if (data.type == 'error') {
                                    alert(data.message)
                                } else {
                                    upd_button(data.busy_time);
                                    next_tab(tab);
                                }
                            }
                        });
                        break;

                    case 'time':
                        time = $("#timeline .btn-primary").text();
                        if (time == ''){
                            alert('Укажите время');
                            break;
                        }
                        $.ajax({
                            url: "/doctor/" + doctor_id + "/",
                            type: "GET",
                            data: {date: date, time:time},
                            success: function(data) {
                                if (data.type == 'error') {
                                    alert(data.message);
                                    upd_button(data.busy_time);
                                } else {
                                    next_tab(tab);
                                }
                            }
                        });
                        break;

                    case 'confirm':
                        fio = $('#fio').val();
                        var csrf = $('input[name="csrfmiddlewaretoken"]').val();
                        if (fio == ''){
                            alert('Укажите ФИО');
                            break;
                        }
                        $.ajax({
                            url: "/doctor/" + doctor_id + "/",
                            type: "POST",
                            data: {date: date, time:time, fio: fio, csrfmiddlewaretoken: csrf},
                            success: function(data) {
                                if (data.type == 'error') {
                                    alert(data.message);
                                } else {
                                    alert(data.message);
                                }
                            }
                        });
                        break;

                    default :
                        next_tab(tab);
                        $("#back").removeClass('hidden');
                }
            });
        </script>
  </body>
</html>







